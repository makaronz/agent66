name: Ultra-Low Latency SMC Trading Agent - CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'optimize-*' ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: smc-trading-agent

jobs:
  # Code Quality and Security Checks
  quality-checks:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt  # If exists

    - name: Run linting
      run: |
        flake8 smc_trading_agent/ --max-line-length=120 --ignore=E203,W503
        black --check smc_trading_agent/
        isort --check-only smc_trading_agent/

    - name: Run type checking
      run: mypy smc_trading_agent/ --ignore-missing-imports

    - name: Run security scan
      run: |
        bandit -r smc_trading_agent/ -f json -o bandit-report.json
        safety check --json --output safety-report.json

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # Comprehensive Testing
  test-suite:
    runs-on: ubuntu-latest
    needs: quality-checks
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_smc
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio pytest-mock

    - name: Run unit tests
      run: |
        pytest tests/unit/ -v --cov=smc_trading_agent --cov-report=xml --cov-report=html

    - name: Run integration tests
      run: |
        pytest tests/integration/ -v --cov=smc_trading_agent --cov-report=xml --cov-append
      env:
        DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_smc
        REDIS_URL: redis://localhost:6379

    - name: Run performance tests
      run: |
        pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark-results.json

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results-${{ matrix.python-version }}
        path: benchmark-results.json

  # Latency and Performance Validation
  performance-validation:
    runs-on: ubuntu-latest
    needs: test-suite
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Start performance test environment
      run: |
        docker-compose -f docker-compose.optimized.yml up -d redis postgres
        sleep 30  # Wait for services to be ready

    - name: Run latency benchmarks
      run: |
        python scripts/validate_latency.py --target-ms 50 --iterations 100

    - name: Run load tests
      run: |
        python scripts/load_test.py --concurrent-users 50 --duration 60s

    - name: Stop test environment
      run: |
        docker-compose -f docker-compose.optimized.yml down

    - name: Upload performance reports
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports
        path: |
          performance-results.json
          load-test-results.json

  # Build and Push Docker Images
  build-and-push:
    runs-on: ubuntu-latest
    needs: [test-suite, performance-validation]
    if: github.event_name == 'push' || github.event_name == 'release'

    strategy:
      matrix:
        component: [base, optimized, runtime]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile.optimized
        target: ${{ matrix.component }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64

    - name: Generate SBOM
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.component }}:${{ steps.meta.outputs.version }}
        format: spdx-json
        output-file: sbom-${{ matrix.component }}.spdx.json

    - name: Upload SBOM
      uses: actions/upload-artifact@v3
      with:
        name: sbom-${{ matrix.component }}
        path: sbom-${{ matrix.component }}.spdx.json

  # Deploy to Staging
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

    - name: Deploy to staging
      run: |
        # Update image tags in deployment files
        sed -i 's|image: smc-trading-agent:latest|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-runtime:${{ github.sha }}|g' deployment/kubernetes/smc-agent-deployment.yaml

        # Apply configurations
        kubectl apply -f deployment/kubernetes/namespace.yaml
        kubectl apply -f deployment/kubernetes/configmap.yaml
        kubectl apply -f deployment/kubernetes/secrets.yaml
        kubectl apply -f deployment/kubernetes/redis-deployment.yaml
        kubectl apply -f deployment/kubernetes/postgres-deployment.yaml
        kubectl apply -f deployment/kubernetes/smc-agent-deployment.yaml

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/smc-trading-agent -n smc-trading --timeout=300s
        kubectl wait --for=condition=available --timeout=300s deployment/smc-trading-agent -n smc-trading

    - name: Run smoke tests
      run: |
        # Wait for service to be ready
        sleep 60

        # Get service endpoint
        SERVICE_URL=$(kubectl get service smc-agent-service -n smc-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

        # Run health checks
        curl -f http://${SERVICE_URL}:8008/api/python/health || exit 1
        curl -f http://${SERVICE_URL}:8008/api/optimized/health || exit 1

    - name: Run integration tests against staging
      run: |
        SERVICE_URL=$(kubectl get service smc-agent-service -n smc-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        python scripts/staging_tests.py --url http://${SERVICE_URL}:8008

  # Deploy to Production
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: github.event_name == 'release'
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure kubectl
      uses: azure/k8s-set-context@v3
      with:
        method: kubeconfig
        kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

    - name: Create production namespace if not exists
      run: |
        kubectl create namespace smc-trading --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy with blue-green strategy
      run: |
        # Update image tags
        sed -i 's|image: smc-trading-agent:latest|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-runtime:${{ github.ref_name }}|g' deployment/kubernetes/smc-agent-deployment.yaml

        # Apply production configurations
        kubectl apply -f deployment/kubernetes/namespace.yaml
        kubectl apply -f deployment/kubernetes/configmap.yaml
        kubectl apply -f deployment/kubernetes/secrets.yaml
        kubectl apply -f deployment/kubernetes/redis-deployment.yaml
        kubectl apply -f deployment/kubernetes/postgres-deployment.yaml

        # Deploy green version
        sed 's/smc-trading-agent/smc-trading-agent-green/g' deployment/kubernetes/smc-agent-deployment.yaml | kubectl apply -f -

    - name: Wait for green deployment
      run: |
        kubectl rollout status deployment/smc-trading-agent-green -n smc-trading --timeout=600s

    - name: Run production health checks
      run: |
        sleep 120  # Extended wait for production

        GREEN_SERVICE_URL=$(kubectl get service smc-agent-service -n smc-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

        # Comprehensive health checks
        curl -f http://${GREEN_SERVICE_URL}:8008/api/python/health || exit 1
        curl -f http://${GREEN_SERVICE_URL}:8008/api/optimized/health || exit 1
        curl -f http://${GREEN_SERVICE_URL}:8008/api/optimized/metrics || exit 1

        # Performance validation
        python scripts/production_performance_check.py --url http://${GREEN_SERVICE_URL}:8008

    - name: Switch traffic to green
      run: |
        # Update service selector to point to green deployment
        kubectl patch service smc-agent-service -n smc-trading -p '{"spec":{"selector":{"app":"smc-trading-agent-green"}}}'

    - name: Verify production deployment
      run: |
        sleep 60  # Wait for DNS and load balancer updates

        # Final verification
        SERVICE_URL=$(kubectl get service smc-agent-service -n smc-trading -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        python scripts/production_verification.py --url http://${SERVICE_URL}:8008

        # Cleanup blue deployment if successful
        kubectl delete deployment smc-trading-agent -n smc-trading --ignore-not-found=true

    - name: Update production monitoring
      run: |
        # Update Grafana dashboards and alerts
        python scripts/update_production_monitoring.py

    - name: Post-deployment notification
      if: always()
      run: |
        python scripts/deployment_notification.py \
          --environment production \
          --status ${{ job.status }} \
          --version ${{ github.ref_name }} \
          --commit ${{ github.sha }}

  # Security Scanning
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' || github.event_name == 'release'

    steps:
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-runtime:${{ github.sha }}
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Run OWASP ZAP Baseline Scan
      run: |
        docker run -t owasp/zap2docker-stable zap-baseline.py \
          -t http://placeholder-url.com \
          -J zap-report.json || true

    - name: Upload security scan results
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results
        path: |
          trivy-results.sarif
          zap-report.json

  # Performance Regression Detection
  performance-regression:
    runs-on: ubuntu-latest
    needs: [performance-validation, deploy-staging]
    if: github.ref == 'refs/heads/develop'

    steps:
    - name: Download benchmark artifacts
      uses: actions/download-artifact@v3
      with:
        name: benchmark-results-3.11
        path: ./benchmarks

    - name: Compare performance with baseline
      run: |
        python scripts/performance_regression_check.py \
          --current ./benchmarks/benchmark-results.json \
          --baseline ./baseline/benchmark-results.json \
          --threshold 10.0

    - name: Performance regression report
      if: failure()
      run: |
        python scripts/performance_regression_report.py \
          --report-file regression-report.md

    - name: Upload regression report
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: performance-regression-report
        path: regression-report.md