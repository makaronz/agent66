name: API Documentation Generation and Validation

on:
  push:
    branches: [main, develop]
    paths:
      - "api/**"
      - "api_fastapi.py"
      - "main.py"
      - ".github/workflows/api-docs.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "api/**"
      - "api_fastapi.py"
      - "main.py"

jobs:
  validate-openapi:
    name: Validate OpenAPI Specifications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Node.js dependencies
        run: npm ci

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install fastapi[all] uvicorn

      - name: Start Express.js API server
        run: |
          npm run server:dev &
          sleep 10
        env:
          NODE_ENV: test
          PORT: 3000

      - name: Start FastAPI server
        run: |
          python -m uvicorn api_fastapi:app --host 0.0.0.0 --port 8000 &
          sleep 10
        env:
          NODE_ENV: test

      - name: Wait for servers to be ready
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 1; done'
          timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 1; done'

      - name: Generate OpenAPI specs
        run: |
          # Generate Express.js OpenAPI spec
          curl -o docs/openapi-express.json http://localhost:3000/api/docs/openapi.json

          # Generate FastAPI OpenAPI spec
          curl -o docs/openapi-fastapi.json http://localhost:8000/api/v1/openapi.json

      - name: Install OpenAPI validation tools
        run: |
          npm install -g @apidevtools/swagger-cli
          npm install -g redoc-cli

      - name: Validate OpenAPI specifications
        run: |
          # Validate Express.js spec
          swagger-cli validate docs/openapi-express.json

          # Validate FastAPI spec
          swagger-cli validate docs/openapi-fastapi.json

      - name: Generate API documentation
        run: |
          # Create docs directory
          mkdir -p docs/api

          # Generate ReDoc documentation for Express.js API
          redoc-cli build docs/openapi-express.json --output docs/api/express-api.html --title "SMC Trading Agent Express API"

          # Generate ReDoc documentation for FastAPI
          redoc-cli build docs/openapi-fastapi.json --output docs/api/fastapi-api.html --title "SMC Trading Agent FastAPI"

          # Generate combined documentation index
          cat > docs/api/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>SMC Trading Agent API Documentation</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .api-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
                  .api-section h2 { color: #333; }
                  .api-section p { color: #666; }
                  .api-link { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; margin: 5px; }
                  .api-link:hover { background: #0056b3; }
              </style>
          </head>
          <body>
              <h1>SMC Trading Agent API Documentation</h1>
              <p>Welcome to the SMC Trading Agent API documentation. This system provides two complementary APIs:</p>
              
              <div class="api-section">
                  <h2>Express.js API (Gateway & Authentication)</h2>
                  <p>Handles user authentication, exchange integrations, and API gateway functionality.</p>
                  <a href="express-api.html" class="api-link">View Express.js API Docs</a>
                  <a href="http://localhost:3000/api/docs" class="api-link">Interactive Swagger UI</a>
              </div>
              
              <div class="api-section">
                  <h2>FastAPI (Trading Engine)</h2>
                  <p>Core trading engine with SMC pattern detection, risk management, and strategy execution.</p>
                  <a href="fastapi-api.html" class="api-link">View FastAPI Docs</a>
                  <a href="http://localhost:8000/api/v1/docs" class="api-link">Interactive Swagger UI</a>
              </div>
              
              <div class="api-section">
                  <h2>API Specifications</h2>
                  <p>Download the OpenAPI specifications for integration and development.</p>
                  <a href="../openapi-express.json" class="api-link">Express.js OpenAPI JSON</a>
                  <a href="../openapi-fastapi.json" class="api-link">FastAPI OpenAPI JSON</a>
              </div>
          </body>
          </html>
          EOF

      - name: Check for breaking changes
        if: github.event_name == 'pull_request'
        run: |
          # Install openapi-diff tool
          npm install -g openapi-diff

          # Compare with main branch specs (if they exist)
          if [ -f "docs/openapi-express-main.json" ]; then
            echo "Checking for breaking changes in Express.js API..."
            openapi-diff docs/openapi-express-main.json docs/openapi-express.json --format json > express-api-diff.json || true
            
            if [ -s express-api-diff.json ]; then
              echo "âš ï¸ Breaking changes detected in Express.js API:"
              cat express-api-diff.json
            else
              echo "âœ… No breaking changes in Express.js API"
            fi
          fi

          if [ -f "docs/openapi-fastapi-main.json" ]; then
            echo "Checking for breaking changes in FastAPI..."
            openapi-diff docs/openapi-fastapi-main.json docs/openapi-fastapi.json --format json > fastapi-diff.json || true
            
            if [ -s fastapi-diff.json ]; then
              echo "âš ï¸ Breaking changes detected in FastAPI:"
              cat fastapi-diff.json
            else
              echo "âœ… No breaking changes in FastAPI"
            fi
          fi

      - name: Upload API documentation artifacts
        uses: actions/upload-artifact@v3
        with:
          name: api-documentation
          path: |
            docs/api/
            docs/openapi-*.json
          retention-days: 30

      - name: Comment PR with documentation links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            let comment = `## ðŸ“š API Documentation Updated

            The API documentation has been generated and validated successfully.

            ### ðŸ“‹ Validation Results
            - âœ… Express.js OpenAPI specification is valid
            - âœ… FastAPI OpenAPI specification is valid

            ### ðŸ”— Documentation Links
            - [Express.js API Documentation](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [FastAPI Documentation](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### ðŸ“Š API Changes
            `;

            // Add breaking changes info if files exist
            if (fs.existsSync('express-api-diff.json')) {
              const diff = fs.readFileSync('express-api-diff.json', 'utf8');
              if (diff.trim()) {
                comment += `
            âš ï¸ **Breaking changes detected in Express.js API**
            \`\`\`json
            ${diff}
            \`\`\`
            `;
              }
            }

            if (fs.existsSync('fastapi-diff.json')) {
              const diff = fs.readFileSync('fastapi-diff.json', 'utf8');
              if (diff.trim()) {
                comment += `
            âš ï¸ **Breaking changes detected in FastAPI**
            \`\`\`json
            ${diff}
            \`\`\`
            `;
              }
            }

            comment += `

            ### ðŸš€ Next Steps
            1. Review the generated documentation
            2. Test the API endpoints using the interactive Swagger UI
            3. Update client SDKs if there are breaking changes
            4. Deploy to staging for integration testing
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  deploy-docs:
    name: Deploy API Documentation
    runs-on: ubuntu-latest
    needs: validate-openapi
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download documentation artifacts
        uses: actions/download-artifact@v3
        with:
          name: api-documentation
          path: docs/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          destination_dir: api-docs

      - name: Update API documentation in wiki
        run: |
          # Clone wiki repository
          git clone https://github.com/${{ github.repository }}.wiki.git wiki
          cd wiki

          # Update API documentation page
          cat > API-Documentation.md << 'EOF'
          # API Documentation

          ## Overview

          The SMC Trading Agent provides two complementary APIs:

          1. **Express.js API**: Authentication, user management, and exchange integrations
          2. **FastAPI**: Core trading engine with SMC pattern detection

          ## Live Documentation

          - [Express.js API Documentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/api/express-api.html)
          - [FastAPI Documentation](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/api/fastapi-api.html)
          - [Combined API Index](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/api/index.html)

          ## OpenAPI Specifications

          - [Express.js OpenAPI JSON](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/openapi-express.json)
          - [FastAPI OpenAPI JSON](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api-docs/openapi-fastapi.json)

          ## Interactive Testing

          ### Development Environment
          - Express.js Swagger UI: http://localhost:3000/api/docs
          - FastAPI Swagger UI: http://localhost:8000/api/v1/docs

          ### Production Environment
          - Express.js Swagger UI: https://api.smctradingagent.com/api/docs
          - FastAPI Swagger UI: https://api.smctradingagent.com/api/v1/docs

          ## Getting Started

          1. **Authentication**: Use `/api/v1/auth/login` to get JWT token
          2. **Exchange Setup**: Configure API keys via `/api/v1/users/api-keys`
          3. **Trading**: Start with `/api/v1/market-data` and `/api/v1/signals`

          ## Support

          - GitHub Issues: [Report bugs or request features](https://github.com/${{ github.repository }}/issues)
          - Email: support@smctradingagent.com
          - Documentation: https://docs.smctradingagent.com

          ---

          *Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
          EOF

          # Commit and push changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add API-Documentation.md
          git commit -m "Update API documentation from CI/CD pipeline" || exit 0
          git push origin master
