apiVersion: batch/v1
kind: CronJob
metadata:
  name: smc-secret-validation
  namespace: smc-trading
  labels:
    app: smc-secret-validation
spec:
  schedule: "*/30 * * * *" # every 30 minutes
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: smc-secret-validation
          annotations:
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: "smc-trading-role"
            vault.hashicorp.com/agent-inject-secret-database: "secret/data/smc-trading/database"
            vault.hashicorp.com/agent-inject-secret-exchanges: "secret/data/smc-trading/exchanges/binance"
            vault.hashicorp.com/agent-inject-secret-jwt: "secret/data/smc-trading/jwt"
        spec:
          restartPolicy: OnFailure
          serviceAccountName: smc-trading-agent
          containers:
            - name: validator
              image: python:3.10-slim
              imagePullPolicy: IfNotPresent
              command: ["/bin/sh", "-c"]
              args:
                - |
                  python - <<'PY'
                  import os, sys
                  required = [
                    ("/vault/secrets/database", ["DATABASE_URL", "DATABASE_PASSWORD"]),
                    ("/vault/secrets/exchanges", ["BINANCE_API_KEY", "BINANCE_API_SECRET"]) ,
                    ("/vault/secrets/jwt", ["JWT_SECRET", "ENCRYPTION_KEY"]) ,
                  ]
                  ok = True
                  for path, keys in required:
                    if not os.path.exists(path):
                      print(f"MISSING FILE: {path}")
                      ok = False
                      continue
                    data = {}
                    with open(path) as f:
                      for line in f:
                        line=line.strip()
                        if not line or line.startswith('#'):
                          continue
                        if '=' in line:
                          k,v = line.split('=',1)
                          data[k]=v
                    for k in keys:
                      if not data.get(k):
                        print(f"MISSING KEY {k} in {path}")
                        ok = False
                  if not ok:
                    sys.exit(1)
                  print("All required secrets present")
                  PY
              securityContext:
                runAsNonRoot: true
                runAsUser: 1000
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
              resources:
                requests:
                  cpu: "50m"
                  memory: "64Mi"
                limits:
                  cpu: "200m"
                  memory: "128Mi"

