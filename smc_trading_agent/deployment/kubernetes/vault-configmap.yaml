apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: vault
data:
  vault.hcl: |
    ui = true
    
    listener "tcp" {
      address = "0.0.0.0:8200"
      tls_disable = 1
    }
    
    storage "consul" {
      address = "consul:8500"
      path = "vault/"
    }
    
    # Enable API addr
    api_addr = "http://vault:8200"
    cluster_addr = "https://vault:8201"
    
    # Disable mlock for containerized environments
    disable_mlock = true
    
    # Enable audit logging
    log_level = "INFO"
    log_format = "json"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-policies
  namespace: vault
data:
  smc-trading-policy.hcl: |
    # Least-privilege policy for SMC Trading Agent
    # Read-only access to specific required secrets
    path "secret/data/smc-trading/database" {
      capabilities = ["read"]
    }

    path "secret/data/smc-trading/jwt" {
      capabilities = ["read"]
    }

    path "secret/data/smc-trading/redis" {
      capabilities = ["read"]
    }

    path "secret/data/smc-trading/supabase" {
      capabilities = ["read"]
    }

    # Exchanges (read-only)
    path "secret/data/smc-trading/exchanges/binance" {
      capabilities = ["read"]
    }

    path "secret/data/smc-trading/exchanges/bybit" {
      capabilities = ["read"]
    }

    path "secret/data/smc-trading/exchanges/oanda" {
      capabilities = ["read"]
    }

    # Allow listing metadata for diagnostics (no secret reads)
    path "secret/metadata/smc-trading/*" {
      capabilities = ["list"]
    }

    # Dynamic database credentials
    path "database/creds/smc-trading-role" {
      capabilities = ["read"]
    }

    # Transit engine for encryption/decryption (update verb)
    path "transit/encrypt/smc-trading" {
      capabilities = ["update"]
    }

    path "transit/decrypt/smc-trading" {
      capabilities = ["update"]
    }
  
  api-gateway-policy.hcl: |
    # Policy for API Gateway
    path "secret/data/api-gateway/*" { capabilities = ["read"] }
    
    path "auth/token/lookup-self" { capabilities = ["read"] }
    
    path "auth/token/renew-self" { capabilities = ["update"] }
  
  execution-engine-policy.hcl: |
    # Policy for Execution Engine
    path "secret/data/execution-engine/*" { capabilities = ["read"] }

    # Read-only per-exchange creds
    path "secret/data/smc-trading/exchanges/*" { capabilities = ["read"] }
    
    path "transit/encrypt/execution-engine" {
      capabilities = ["update"]
    }
    
    path "transit/decrypt/execution-engine" {
      capabilities = ["update"]
    }