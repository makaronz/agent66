apiVersion: v1
kind: ConfigMap
metadata:
  name: waf-rules
  namespace: smc-trading
data:
  # ModSecurity WAF rules
  modsecurity.conf: |
    SecRuleEngine On
    SecRequestBodyAccess On
    SecRule REQUEST_HEADERS:Content-Type "text/xml" \
      "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
    SecRule REQBODY_ERROR "!@eq 0" \
      "id:'200001',phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}'"
    SecRule REQUEST_HEADERS:Content-Type "text/xml" \
      "id:'200002',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"
    SecRule REQBODY_ERROR "!@eq 0" \
      "id:'200003',phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}'"
    
    # SQL Injection rules
    SecRule ARGS|ARGS_NAMES "@detectSQLi" \
      "id:'942100',phase:2,block,msg:'SQL Injection Attack Detected via libinjection',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}'"
    
    # XSS rules
    SecRule ARGS|ARGS_NAMES "@detectXSS" \
      "id:'941100',phase:2,block,msg:'XSS Attack Detected via libinjection',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}'"
    
    # Path traversal
    SecRule ARGS|ARGS_NAMES "@contains ../" \
      "id:'930100',phase:2,block,msg:'Path Traversal Attack Detected',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}'"
    
    # Command injection
    SecRule ARGS|ARGS_NAMES "@detectSQLi" \
      "id:'932100',phase:2,block,msg:'Remote Command Execution: Unix Command Injection',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}'"
    
    # Rate limiting
    SecRule &RATE_LIMIT "@gt 10" \
      "id:'949110',phase:2,block,msg:'Rate Limit Exceeded',logdata:'Rate limit: %{RATE_LIMIT}'"
    
    # Block common attack tools
    SecRule REQUEST_HEADERS:User-Agent "@pm sqlmap nikto w3af" \
      "id:'949120',phase:1,block,msg:'Attack Tool Detected',logdata:'User-Agent: %{MATCHED_VAR}'"
    
    # Block suspicious file uploads
    SecRule FILES|FILES_NAMES "@rx \.(php|jsp|asp|aspx|exe|bat|cmd|sh|pl|py|rb)$" \
      "id:'949130',phase:2,block,msg:'Suspicious File Upload Detected',logdata:'File: %{MATCHED_VAR}'"
    
    # Custom rules for trading application
    SecRule ARGS:symbol "@rx [^a-zA-Z0-9/_-]" \
      "id:'949140',phase:2,block,msg:'Invalid Symbol Format',logdata:'Symbol: %{MATCHED_VAR}'"
    
    SecRule ARGS:quantity "@rx [^0-9.]" \
      "id:'949150',phase:2,block,msg:'Invalid Quantity Format',logdata:'Quantity: %{MATCHED_VAR}'"
    
    SecRule ARGS:price "@rx [^0-9.]" \
      "id:'949160',phase:2,block,msg:'Invalid Price Format',logdata:'Price: %{MATCHED_VAR}'"
    
    # Block excessive API calls
    SecRule &API_CALLS "@gt 100" \
      "id:'949170',phase:2,block,msg:'Excessive API Calls Detected',logdata:'API calls: %{API_CALLS}'"
    
    # Log all blocked requests
    SecRule REQUEST_URI "@rx .*" \
      "id:'949180',phase:1,pass,log,msg:'Request logged for analysis'"