# Logstash configuration for SMC Trading Agent audit logs
# Processes JSON audit logs and sends them to Elasticsearch

input {
  # File input for audit logs
  file {
    path => "/var/log/smc-trading/audit/*.jsonl"
    start_position => "beginning"
    codec => "json"
    type => "audit"
    tags => ["audit", "smc-trading"]
  }
  
  # File input for application logs
  file {
    path => "/var/log/smc-trading/app/*.log"
    start_position => "beginning"
    type => "application"
    tags => ["application", "smc-trading"]
  }
  
  # Beats input for container logs
  beats {
    port => 5044
  }
  
  # HTTP input for real-time log streaming
  http {
    port => 8080
    codec => "json"
    type => "realtime"
    tags => ["realtime", "smc-trading"]
  }
}

filter {
  # Process audit logs
  if [type] == "audit" {
    # Parse timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
    
    # Add geolocation for IP addresses
    if [ip_address] and [ip_address] != "unknown" {
      geoip {
        source => "ip_address"
        target => "geoip"
        add_tag => [ "geoip" ]
      }
    }
    
    # Enrich with risk level
    if [risk_score] {
      if [risk_score] >= 8 {
        mutate { add_field => { "risk_level" => "HIGH" } }
      } else if [risk_score] >= 5 {
        mutate { add_field => { "risk_level" => "MEDIUM" } }
      } else {
        mutate { add_field => { "risk_level" => "LOW" } }
      }
    }
    
    # Add compliance flags
    if [event_type] in ["GDPR_REQUEST", "DATA_EXPORT", "DATA_DELETION", "AUDIT_TRAIL_ACCESS"] {
      mutate { add_tag => [ "compliance" ] }
    }
    
    # Add security flags
    if [event_type] in ["UNAUTHORIZED_ACCESS", "SUSPICIOUS_ACTIVITY", "API_KEY_COMPROMISED", "SECURITY_SCAN_FAILED"] {
      mutate { add_tag => [ "security_incident" ] }
    }
    
    # Add trading flags
    if [event_type] in ["ORDER_PLACED", "ORDER_FILLED", "POSITION_OPENED", "POSITION_CLOSED"] {
      mutate { add_tag => [ "trading_activity" ] }
    }
  }
  
  # Process application logs
  if [type] == "application" {
    # Parse common log formats
    grok {
      match => { 
        "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:logger} %{GREEDYDATA:message}" 
      }
      overwrite => [ "message" ]
    }
    
    # Parse timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Add common fields
  mutate {
    add_field => { 
      "environment" => "${ENVIRONMENT:development}"
      "service" => "smc-trading-agent"
      "version" => "${APP_VERSION:1.0.0}"
    }
  }
  
  # Remove sensitive fields
  mutate {
    remove_field => [ "password", "secret", "token", "api_key", "api_secret", "private_key" ]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:elasticsearch:9200}"]
    index => "smc-trading-%{type}-%{+YYYY.MM.dd}"
    template_name => "smc-trading"
    template => "/etc/logstash/templates/smc-trading.json"
    template_overwrite => true
  }
  
  # Send high-risk events to separate index for alerting
  if [risk_score] and [risk_score] >= 8 {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOST:elasticsearch:9200}"]
      index => "smc-trading-security-alerts-%{+YYYY.MM.dd}"
    }
  }
  
  # Send to stdout for debugging (remove in production)
  if "${DEBUG_OUTPUT:false}" == "true" {
    stdout { 
      codec => rubydebug 
    }
  }
  
  # Send alerts to external systems
  if "security_incident" in [tags] {
    # Send to Slack (configure webhook URL)
    http {
      url => "${SLACK_WEBHOOK_URL}"
      http_method => "post"
      format => "json"
      mapping => {
        "text" => "ðŸš¨ Security Incident: %{event_type} from %{ip_address} at %{timestamp}"
        "username" => "SMC Trading Security"
        "channel" => "#security-alerts"
      }
    }
  }
  
  # Send compliance events to audit system
  if "compliance" in [tags] {
    # Send to compliance monitoring system
    http {
      url => "${COMPLIANCE_WEBHOOK_URL}"
      http_method => "post"
      format => "json"
      headers => {
        "Authorization" => "Bearer ${COMPLIANCE_API_TOKEN}"
      }
    }
  }
}