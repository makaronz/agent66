apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-streams-config
  namespace: smc-trading
data:
  streams-config.yaml: |
    kafka:
      bootstrap_servers:
        - "kafka-0.kafka-service.kafka.svc.cluster.local:9092"
        - "kafka-1.kafka-service.kafka.svc.cluster.local:9092"
        - "kafka-2.kafka-service.kafka.svc.cluster.local:9092"
      
    stream_processors:
      market_data_processor:
        consumer_group: "smc-market-data-processor"
        processing_mode: "exactly_once"
        batch_size: 100
        commit_interval_ms: 5000
        max_poll_records: 500
        input_topics:
          - "market_data.binance.btcusdt.trades"
          - "market_data.binance.ethusdt.trades"
          - "market_data.bybit.btcusdt.trades"
          - "market_data.bybit.ethusdt.trades"
          - "market_data.oanda.eurusd.trades"
          - "market_data.binance.btcusdt.orderbook"
          - "market_data.binance.ethusdt.orderbook"
          - "market_data.bybit.btcusdt.orderbook"
          - "market_data.bybit.ethusdt.orderbook"
        output_topics:
          enriched_trades: "enriched_trades"
          enriched_orderbook: "enriched_orderbook"
          enriched_klines: "enriched_klines"
          smc_signals: "smc_signals"
      
      kline_processor:
        consumer_group: "smc-kline-processor"
        processing_mode: "exactly_once"
        batch_size: 50
        commit_interval_ms: 10000
        max_poll_records: 200
        input_topics:
          - "market_data.binance.btcusdt.klines"
          - "market_data.binance.ethusdt.klines"
          - "market_data.bybit.btcusdt.klines"
          - "market_data.bybit.ethusdt.klines"
          - "market_data.oanda.eurusd.klines"
        output_topics:
          enriched_klines: "enriched_klines"
          smc_signals: "smc_signals"

    logging:
      level: "INFO"
      format: "json"

    monitoring:
      metrics_port: 8080
      health_check_port: 8081
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-streams-service
  namespace: smc-trading
  labels:
    app: kafka-streams
spec:
  ports:
    - port: 8080
      name: metrics
    - port: 8081
      name: health
  selector:
    app: kafka-streams
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka-streams
  namespace: smc-trading
  labels:
    app: kafka-streams
    component: stream-processing
spec:
  replicas: 3
  selector:
    matchLabels:
      app: kafka-streams
  template:
    metadata:
      labels:
        app: kafka-streams
        component: stream-processing
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - kafka-streams
                topologyKey: kubernetes.io/hostname
      containers:
        - name: kafka-streams
          image: smc-trading/stream-processor:latest
          ports:
            - containerPort: 8080
              name: metrics
            - containerPort: 8081
              name: health
          env:
            - name: KAFKA_BOOTSTRAP_SERVERS
              value: "kafka-0.kafka-service.kafka.svc.cluster.local:9092,kafka-1.kafka-service.kafka.svc.cluster.local:9092,kafka-2.kafka-service.kafka.svc.cluster.local:9092"
            - name: PROCESSOR_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: LOG_LEVEL
              value: "INFO"
            - name: PYTHONPATH
              value: "/app"
          volumeMounts:
            - name: config
              mountPath: /app/config
            - name: logs
              mountPath: /app/logs
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          startupProbe:
            httpGet:
              path: /health
              port: 8081
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 30
      volumes:
        - name: config
          configMap:
            name: kafka-streams-config
        - name: logs
          emptyDir: {}
      restartPolicy: Always
      terminationGracePeriodSeconds: 60
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: kafka-streams-hpa
  namespace: smc-trading
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: kafka-streams
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
    - type: Pods
      pods:
        metric:
          name: kafka_consumer_lag_sum
        target:
          type: AverageValue
          averageValue: "1000"
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
