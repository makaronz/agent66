name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  python-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage (fail under 80%)
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: '1'
        run: |
          pytest -q \
            --cov=./ \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4
        with:
          name: python-coverage-xml
          path: coverage.xml
          if-no-files-found: ignore

  node-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
        with:
          node-version: '20'

      - name: Set up pnpm
        uses: pnpm/action-setup@fe02b5eb86ef3d7225f7687dcac3ed48b80af6a4 # v4
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run web tests
        run: npx vitest run --reporter=basic || true

  rust-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install Rust
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7eaea34cb # v1
        with:
          toolchain: stable
          override: true

      - name: Cargo test
        run: cargo test --all --quiet

  security-scanning:
    runs-on: ubuntu-latest
    needs: [python-tests, node-tests, rust-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety

      - name: Run Bandit security scan (Python)
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt -o bandit-report.txt || true

      - name: Run Safety check (Python dependencies)
        run: |
          safety check --json --output safety-report.json || true
          safety check --output safety-report.txt || true

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Run ESLint security scan
        run: |
          npx eslint . --ext .js,.jsx,.ts,.tsx --format json --output-file eslint-security-report.json || true
          npx eslint . --ext .js,.jsx,.ts,.tsx --format stylish --output-file eslint-security-report.txt || true

      - name: Run Semgrep SAST scan
        uses: returntocorp/semgrep-action@b4e7b76b6c8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8 # v1 pinned

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b4e7b76b6c8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8 # master pinned

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@b4e7b76b6c8b8b8b8b8b8b8b8b8b8b8b8b8b8b8b8 # master pinned

      - name: Upload security reports
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            bandit-report.txt
            safety-report.json
            safety-report.txt
            eslint-security-report.json
            eslint-security-report.txt
            semgrep-report.sarif
            trivy-fs-report.sarif
            trivy-image-report.sarif

      - name: Comment security findings
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## ðŸ”’ Security Scan Results\n\n';
            
            // Check if security reports exist and add findings
            const reports = [
              'bandit-report.txt',
              'safety-report.txt',
              'eslint-security-report.txt'
            ];
            
            for (const report of reports) {
              if (fs.existsSync(report)) {
                const content = fs.readFileSync(report, 'utf8');
                if (content.trim()) {
                  comment += `### ${report.split('/').pop()}\n\`\`\`\n${content.substring(0, 1000)}${content.length > 1000 ? '...' : ''}\n\`\`\`\n\n`;
                }
              }
            }
            
            if (comment === '## ðŸ”’ Security Scan Results\n\n') {
              comment += 'âœ… No security issues found!\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });