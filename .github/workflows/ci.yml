name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  python-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: smc_trading_agent
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d # v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage (fail under 80%)
        env:
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: '1'
        run: |
          pytest -q \
            --cov=./ \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4
        with:
          name: python-coverage-xml
          path: smc_trading_agent/coverage.xml
          if-no-files-found: ignore

  node-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: smc_trading_agent
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4
        with:
          node-version: '20'

      - name: Set up pnpm
        uses: pnpm/action-setup@fe02b5eb86ef3d7225f7687dcac3ed48b80af6a4 # v4
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run web tests
        run: npx vitest run --reporter=basic || true

  rust-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: smc_trading_agent
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Install Rust
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7eaea34cb # v1
        with:
          toolchain: stable
          override: true

      - name: Cargo test
        run: cargo test --all --quiet

